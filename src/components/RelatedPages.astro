---
import { getCollection } from 'astro:content';

interface Props {
  currentSlug: string;
  currentSection: string;
  limit?: number;
}

const { currentSlug, currentSection, limit = 3 } = Astro.props;

const allPages = await getCollection('pages', ({ data }) => {
  return !data.draft;
}).then(pages => pages.filter(p => p.slug !== currentSlug));

// Prioritize same section, then others
const sameSection = allPages
  .filter((page) => page.data.section === currentSection)
  .slice(0, limit);

const otherPages = allPages
  .filter((page) => page.data.section !== currentSection)
  .slice(0, Math.max(0, limit - sameSection.length));

const related = [...sameSection, ...otherPages].slice(0, limit);
---

{related.length > 0 && (
  <section class="my-16 border-t border-white/10 pt-12">
    <h2 class="text-2xl font-serif-display font-normal mb-8 text-gray-100">Related Articles</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      {related.map((page) => {
        const sectionPath = page.data.section === 'use-cases' ? '/use-cases' 
          : page.data.section === 'comparisons' ? '/comparisons' 
          : '/guides';
        const url = `${sectionPath}/${page.slug}`;
        return (
          <a
            href={url}
            class="block border-b border-white/10 pb-6 hover:border-white/20 transition-colors"
          >
            <h3 class="font-sans font-normal text-lg mb-3 text-gray-100">{page.data.title}</h3>
            <p class="text-gray-400 text-sm leading-relaxed">{page.data.description}</p>
          </a>
        );
      })}
    </div>
  </section>
)}
